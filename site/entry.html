<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- PDBe Mol* plugin -->
  <script src="https://cdn.jsdelivr.net/npm/pdbe-molstar@latest/build/pdbe-molstar-plugin.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pdbe-molstar@latest/build/pdbe-molstar.css" />

  <style>
    /* ---- clamp the viewer to a box ---- */
    html, body { height: auto !important; }        /* undo any global 100% from PDBe CSS */
    .viewer-card {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;            /* hide any overflow from Mol* canvas */
      margin-bottom: 16px;
    }
    #viewer-container {
      width: 100%;
      height: 640px;               /* <— adjust this to taste */
    }
    /* Make sure Mol* respects our container size */
    #viewer-container .msp-layout,
    #viewer-container .msp-viewport,
    #viewer-container canvas {
      width: 100% !important;
      height: 100% !important;
      max-width: 100% !important;
      max-height: 100% !important;
    }
  </style>
</head>
<body>
  <a href="index.html">← Back</a>
  <h1 id="title"></h1>

  <div class="viewer-card">
    <div id="viewer-container"></div>
  </div>
  <div id="err" style="color:#b00020; margin-top:8px;"></div>

  <h2>Sequence (FASTA)</h2>
  <pre id="fasta">Loading...</pre>

  <script>
    function getParam(name){ return new URL(location.href).searchParams.get(name); }

    async function load(){
      const uid = getParam('uid');
      const errEl = document.getElementById('err');
      document.getElementById('title').textContent = uid || '(missing uid)';

      const catalog = await fetch('../data/entries.json?v=box').then(r => r.json()).catch(() => null);
      if(!catalog){ errEl.textContent = 'Could not load entries.json.'; return; }
      const entry = catalog.entries.find(e => e.uniprot_id === uid);
      if(!entry){ errEl.textContent = 'Entry not found in catalog.'; return; }

      // FASTA
      fetch(entry.files.sequence_fasta).then(r=>r.text()).then(t=>{
        document.getElementById('fasta').textContent = t;
      }).catch(()=>{ document.getElementById('fasta').textContent = 'FASTA not available.'; });

      // PDBe Mol* viewer (inside our fixed-size box)
      try {
        const viewer = new PDBeMolstarPlugin();
        viewer.render('viewer-container', {
          customData: { url: entry.files.structure_cif, format: 'mmcif' }, // falls back fine even for .cif in most cases
          ui: true,
          bgColor: { r: 255, g: 255, b: 255 },
        });
      } catch (e) {
        console.error('PDBe Mol* failed', e);
        errEl.textContent = 'Could not load the 3D viewer.';
      }
    }
    load();
  </script>
</body>
</html>
