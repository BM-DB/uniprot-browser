<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root { --pad: 12px; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    a { text-decoration: none; }

    .bar { padding: 10px var(--pad); }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 0 var(--pad) 16px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 300px;
    }
    .card h3 {
      margin: 0;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
      font-size: 15px;
    }

    /* Left viewer box */
    #viewer-wrap { position: relative; height: 640px; }
    #viewer-frame { position:absolute; inset:0; width:100%; height:100%; border:0; display:block; }

    /* Right sequence panel */
    #seq-panel { display:flex; flex-direction:column; height:640px; }
    #seq-toolbar {
      display:flex; align-items:center; gap:8px;
      padding:8px 12px; border-bottom:1px solid #eee; background:#fafafa;
    }
    .btn { padding:6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; background:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    /* Sequence box (static) */
    #seq-box {
      padding: 12px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.65;
      white-space: pre-wrap;
      word-break: break-word;
      background: #fff;
      flex: 1;
    }

    /* Optional soft line-number “ruler” every 10 residues (CSS-only visual aid) */
    .chunk-10 { color:#6b7280; }  /* muted gray for separators */

    .links { display:flex; gap:12px; align-items:center; margin: 6px var(--pad) 16px; }
    .error { color:#b00020; margin: 8px var(--pad) 0; }
  </style>
</head>
<body>
  <div class="bar"><a href="index.html">← Back</a></div>
  <div class="bar"><h1 id="title" style="margin:0"></h1></div>

  <div class="grid">
    <!-- Left: Mol* (hosted, minimal) -->
    <div class="card">
      <h3>Structure</h3>
      <div id="viewer-wrap">
        <iframe id="viewer-frame" src="about:blank" title="Mol* Viewer (minimal)"></iframe>
      </div>
    </div>

    <!-- Right: FASTA (static) -->
    <div class="card">
      <h3>Sequence</h3>
      <div id="seq-panel">
        <div id="seq-toolbar">
          <button id="copyBtn" class="btn" type="button">Copy FASTA</button>
        </div>
        <pre id="seq-box">Loading…</pre>
      </div>
    </div>
  </div>

  <div class="links">
    <strong>Files:</strong>
    <a id="cifLink"   target="_blank" rel="noopener">CIF</a>
    <a id="fastaLink" target="_blank" rel="noopener">FASTA</a>
  </div>

  <div id="err" class="error"></div>

  <script>
    const getParam = name => new URL(location.href).searchParams.get(name);

    // split sequence into blocks of 10 and 50 for easier reading (purely visual)
    function formatSequence(seq) {
      const out = [];
      for (let i = 0; i < seq.length; i++) {
        out.push(seq[i]);
        const at = i + 1;
        if (at % 10 === 0) out.push('<span class="chunk-10"> </span>');
        if (at % 50 === 0) out.push('\n');
      }
      return out.join('').replace(/\n+$/,'');
    }

    async function load() {
      const uid       = getParam('uid');
      const errEl     = document.getElementById('err');
      const titleEl   = document.getElementById('title');
      const seqBox    = document.getElementById('seq-box');
      const cifLink   = document.getElementById('cifLink');
      const fastaLink = document.getElementById('fastaLink');
      const frame     = document.getElementById('viewer-frame');
      const copyBtn   = document.getElementById('copyBtn');

      titleEl.textContent = uid || '(missing uid)';

      // Load catalog with cache-buster
      let catalog;
      try {
        catalog = await fetch('../data/entries.json?v=' + Date.now()).then(r => r.json());
      } catch (e) {
        errEl.textContent = 'Could not load entries.json.'; return;
      }

      const entry = (catalog.entries || []).find(e => e.uniprot_id === uid);
      if (!entry) { errEl.textContent = 'Entry not found in catalog.'; return; }

      // Wire file links
      const cifUrl   = entry.files.structure_cif;
      const fastaUrl = entry.files.sequence_fasta;
      cifLink.href   = cifUrl;
      fastaLink.href = fastaUrl;

      // Show FASTA text (static) + copy
      let fastaText = '';
      try {
        fastaText = await fetch(fastaUrl, { cache: 'no-store' }).then(r => r.text());
        const seqOnly = fastaText.split(/\r?\n/).filter(l => !l.startsWith('>')).join('').trim();
        seqBox.innerHTML = formatSequence(seqOnly) || '(no sequence)';
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(fastaText);
          copyBtn.textContent = 'Copied!';
          setTimeout(() => copyBtn.textContent = 'Copy FASTA', 1200);
        };
      } catch {
        seqBox.textContent = 'FASTA not available.';
        copyBtn.disabled = true;
      }

      // Build hosted Mol* URL in minimal mode.
      // Keep params conservative to avoid falling back to the full app UI.
      const encoded = encodeURIComponent(cifUrl);
      const viewerUrl =
        `https://molstar.org/viewer/?structure-url=${encoded}` +
        `&structure-url-format=mmcif` +
        `&hide-controls=1`;

      frame.src = viewerUrl;
    }

    load();
  </script>
</body>
</html>
