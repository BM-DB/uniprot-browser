<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- PDBe Mol* (pinned) -->
  <script src="https://unpkg.com/pdbe-molstar@3.7.1/build/pdbe-molstar-plugin.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/pdbe-molstar@3.7.1/build/pdbe-molstar-light.css" />

  <style>
    :root { --gap: 12px; --card-border: #ddd; }
    html, body { height: 100%; margin: 0; background: #fff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    .topbar { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--card-border); }
    .topbar a { text-decoration: none; }
    .title { font-size: 20px; font-weight: 600; margin: 0; }

    .main {
      height: calc(100vh - 54px);
      display: flex; gap: var(--gap);
      padding: var(--gap); box-sizing: border-box;
    }
    .col {
      flex: 1 1 50%; min-width: 0;
      display: flex; flex-direction: column;
      border: 1px solid var(--card-border); border-radius: 8px;
      overflow: hidden; background: #fff;
    }

    #viewer-wrap { position: relative; flex: 1 1 auto; }
    #viewer { position: absolute; inset: 0; }
    #viewer .msp-viewport, #viewer canvas {
      width: 100% !important; height: 100% !important;
      max-width: 100% !important; max-height: 100% !important;
    }

    .msp-left-panel,.msp-right-panel,.msp-bottom-panel,
    .msp-layout-controls,.msp-viewport-controls,
    .msp-plugin-ui,.msp-controls,.msp-controls-wrapper,.msp-help-toast {
      display: none !important; visibility: hidden !important; pointer-events: none !important;
    }

    .seq-header {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 12px; border-bottom: 1px solid var(--card-border);
      background: #fafafa; flex-wrap: wrap;
    }
    .seq-header strong { margin-right: 4px; }
    .seq-header a { text-decoration: none; }
    .btn { padding: 6px 10px; border: 1px solid var(--card-border); border-radius: 6px; cursor: pointer; background: #fff; }
    .seq-body { flex: 1 1 auto; overflow: auto; padding: 12px; }

    .error { color: #b00020; padding: 8px 12px; border-top: 1px solid var(--card-border); background: #fff7f7; }

    /* Interactive sequence strip */
    .seq-strip { font: 13px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .seq-chain { margin-bottom: 10px; }
    .seq-chain h4 { margin: 8px 0 6px; font: 600 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .seq-res {
      display: inline-block; padding: 2px 3px; margin: 0 1px 1px 0;
      border-radius: 3px; cursor: pointer; user-select: none;
    }
    .seq-res:hover { background:#eef6ff; }
    .seq-res.active { background:#cfe8ff; outline: 1px solid #8bbcff; }

    .muted { color:#666; font-size:12px; margin: 6px 0 0; }
  </style>
</head>
<body>
  <div class="topbar">
    <a href="index.html">← Back</a>
    <h1 id="title" class="title"></h1>
  </div>

  <div class="main">
    <!-- Left: Mol* viewer -->
    <div class="col">
      <div id="viewer-wrap">
        <div id="viewer"></div>
      </div>
      <div id="viewer-error" class="error" style="display:none;"></div>
    </div>

    <!-- Right: sequence + links -->
    <div class="col">
      <div class="seq-header">
        <strong>Files:</strong>
        <a id="cifLink"   target="_blank" rel="noopener">CIF</a>
        <a id="fastaLink" target="_blank" rel="noopener">FASTA</a>
        <button id="copyBtn" class="btn" type="button">Copy FASTA</button>
      </div>
      <div class="seq-body" id="seq-body">
        <!-- We will inject the interactive strip here (FASTA first, then upgrade to structure-derived). -->
      </div>
      <div id="seq-error" class="error" style="display:none;"></div>
    </div>
  </div>

  <script>
    function getParam(name){ return new URL(location.href).searchParams.get(name); }

    // --- helpers for PDBe visual API
    function pdbeHighlight(viewer, asym, auth) {
      try { viewer.visual.highlight({ data: [{ struct_asym_id: asym, start_residue_number: auth, end_residue_number: auth }] }); } catch {}
    }
    function pdbeClearHighlight(viewer) {
      try { viewer.visual.clearHighlight(); } catch {}
    }
    function pdbeSelect(viewer, asym, auth) {
      try {
        viewer.visual.clearSelection?.();
        viewer.visual.select({ data: [{ struct_asym_id: asym, start_residue_number: auth, end_residue_number: auth }] });
      } catch {}
    }

    // Build an interactive strip from a plain sequence string (fallback).
    // We assume single chain "A" and 1-based residue numbering so clicks still drive the 3D if the auth_seq_id matches.
    function buildStripFromFasta(seqText, viewer) {
      const seq = seqText.split(/\r?\n/).filter(l => !l.startsWith('>')).join('').trim();
      const container = document.createElement('div');
      container.className = 'seq-strip';

      const block = document.createElement('div');
      block.className = 'seq-chain';
      const header = document.createElement('h4');
      header.textContent = 'Chain A (FASTA)';
      block.appendChild(header);

      for (let i = 0; i < seq.length; i++) {
        const sp = document.createElement('span');
        sp.className = 'seq-res';
        sp.textContent = seq[i] || 'X';
        const auth = i + 1;
        const asym = 'A';
        sp.title = `${seq[i] || 'X'} ${auth}`;
        sp.dataset.asym = asym;
        sp.dataset.auth = String(auth);

        sp.addEventListener('mouseenter', () => { pdbeHighlight(viewer, asym, auth); sp.classList.add('active'); });
        sp.addEventListener('mouseleave', () => { pdbeClearHighlight(viewer); sp.classList.remove('active'); });
        sp.addEventListener('click',      () => { pdbeSelect(viewer, asym, auth); sp.classList.add('active'); setTimeout(()=>sp.classList.remove('active'), 600); });

        block.appendChild(sp);
      }

      container.appendChild(block);

      const note = document.createElement('div');
      note.className = 'muted';
      note.textContent = 'Showing FASTA-based sequence strip. It will auto-upgrade once the 3D model is ready.';
      container.appendChild(note);

      return container;
    }

    // Build interactive strip from Mol* model columns (best).
    function buildStripFromModel(model, viewer) {
      const { residues, chains } = model.atomicHierarchy || {};
      if (!residues || !chains) return null;

      const label_comp_id = residues.label_comp_id;   // Column<string>
      const auth_seq_id   = residues.auth_seq_id;     // Column<number>
      const chainIndex    = residues.chainIndex;      // Int32Array
      const label_asym_id = chains.label_asym_id;     // Column<string>
      if (!label_comp_id || !auth_seq_id || !chainIndex || !label_asym_id) return null;

      const to1 = (aa3) => {
        const m = {ALA:'A',ARG:'R',ASN:'N',ASP:'D',CYS:'C',GLN:'Q',GLU:'E',GLY:'G',HIS:'H',ILE:'I',LEU:'L',LYS:'K',MET:'M',PHE:'F',PRO:'P',SER:'S',THR:'T',TRP:'W',TYR:'Y',VAL:'V',SEC:'U',PYL:'O'};
        return m[aa3?.toUpperCase()] || 'X';
      };

      const byChain = new Map(); // asym -> array of {one, three, auth, asym}
      const nResidues = residues._rowCount | 0;

      for (let rI = 0; rI < nResidues; rI++) {
        const cIdx  = chainIndex[rI];
        const asym  = label_asym_id.value(cIdx);
        const comp3 = label_comp_id.value(rI);
        const auth  = auth_seq_id.value(rI);
        const one   = to1(comp3);
        if (!byChain.has(asym)) byChain.set(asym, []);
        byChain.get(asym).push({ one, three: comp3, auth, asym });
      }

      const container = document.createElement('div');
      container.className = 'seq-strip';

      byChain.forEach((list, asym) => {
        const block = document.createElement('div');
        block.className = 'seq-chain';

        const header = document.createElement('h4');
        header.textContent = `Chain ${asym}`;
        block.appendChild(header);

        list.forEach(res => {
          const sp = document.createElement('span');
          sp.className = 'seq-res';
          sp.textContent = res.one;
          sp.title = `${res.three} ${res.auth}`;
          sp.dataset.asym = res.asym;
          sp.dataset.auth = String(res.auth);

          sp.addEventListener('mouseenter', () => { pdbeHighlight(viewer, res.asym, res.auth); sp.classList.add('active'); });
          sp.addEventListener('mouseleave', () => { pdbeClearHighlight(viewer); sp.classList.remove('active'); });
          sp.addEventListener('click',      () => { pdbeSelect(viewer,   res.asym, res.auth); sp.classList.add('active'); setTimeout(()=>sp.classList.remove('active'), 600); });

          block.appendChild(sp);
        });

        container.appendChild(block);
      });

      return container;
    }

    // Wait for Mol* structure to be present
    async function waitForModel(viewer, timeoutMs=12000) {
      const start = performance.now();
      const plugin = viewer?.viewerInstance?.plugin;
      while (performance.now() - start < timeoutMs) {
        const hier = plugin?.managers?.structure?.hierarchy?.current;
        const sRef = hier?.structures?.[0];
        const structure = sRef?.cell?.obj?.data?.structure;
        const model = structure?.models?.[0];
        if (model?.atomicHierarchy) return model;
        await new Promise(r => setTimeout(r, 120));
      }
      return null;
    }

    async function load(){
      const uid = getParam('uid');
      const titleEl  = document.getElementById('title');
      const cifLink  = document.getElementById('cifLink');
      const fastaLink= document.getElementById('fastaLink');
      const copyBtn  = document.getElementById('copyBtn');
      const viewerErr= document.getElementById('viewer-error');
      const seqErr   = document.getElementById('seq-error');
      const seqBody  = document.getElementById('seq-body');

      titleEl.textContent = uid || '(missing uid)';

      // Load catalog
      let catalog;
      try {
        catalog = await fetch('../data/entries.json?v=' + Date.now()).then(r=>r.json());
      } catch {
        viewerErr.style.display = seqErr.style.display = 'block';
        viewerErr.textContent = seqErr.textContent = 'Could not load entries.json.';
        return;
      }

      const entry = (catalog.entries || []).find(e => e.uniprot_id === uid);
      if(!entry){
        viewerErr.style.display = seqErr.style.display = 'block';
        viewerErr.textContent = seqErr.textContent = 'Entry not found in catalog.';
        return;
      }

      const cifUrl   = entry.files.structure_cif;
      const fastaUrl = entry.files.sequence_fasta;
      cifLink.href   = cifUrl;
      fastaLink.href = fastaUrl;

      // Load FASTA and render a clickable fallback strip immediately
      let fastaText = '';
      try {
        fastaText = await fetch(fastaUrl).then(r=>r.text());
        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(fastaText);
            const prev = copyBtn.textContent; copyBtn.textContent = 'Copied!';
            setTimeout(()=> (copyBtn.textContent = prev), 1200);
          } catch {}
        };
      } catch {
        seqErr.style.display = 'block';
        seqErr.textContent = 'FASTA not available.';
        copyBtn.disabled = true;
      }

      // Init PDBe Mol*
      const fmt = (cifUrl.toLowerCase().endsWith('.cif') && !cifUrl.toLowerCase().endsWith('.mmcif')) ? 'cif' : 'mmcif';
      let pdbe;
      try { pdbe = new PDBeMolstarPlugin(); }
      catch {
        viewerErr.style.display = 'block';
        viewerErr.textContent = 'Failed to create PDBe Mol* plugin.';
        return;
      }

      try {
        pdbe.render('viewer', {
          customData: { url: cifUrl, format: fmt },
          hideControls: true, expanded: false,
          bgColor: { r:255, g:255, b:255 }
        });
      } catch {
        viewerErr.style.display = 'block';
        viewerErr.textContent = 'Mol* render error.';
        return;
      }

      // Hide chrome defensively
      const root = document.getElementById('viewer');
      const hideChrome = () => {
        [
          '.msp-left-panel','.msp-right-panel','.msp-bottom-panel',
          '.msp-layout-controls','.msp-viewport-controls',
          '.msp-plugin-ui','.msp-controls','.msp-controls-wrapper','.msp-help-toast'
        ].forEach(sel => { document.querySelectorAll(sel).forEach(el => { el.style.display='none'; el.style.visibility='hidden'; el.style.pointerEvents='none'; }); });
      };
      hideChrome(); setTimeout(hideChrome, 100); setTimeout(hideChrome, 500);
      new MutationObserver(hideChrome).observe(root, { childList:true, subtree:true });

      // Style scene a bit
      function styleScene() {
        try {
          const plugin = pdbe?.viewerInstance?.plugin;
          const c3d = plugin?.canvas3d;
          if (c3d?.setProps) {
            c3d.setProps({
              renderer: { ambientIntensity: 0.6 },
              postprocessing: { outline: { enable: true, scale: 1.0, threshold: 0.8 } }
            });
          }
        } catch {}
      }
      setTimeout(styleScene, 400);
      setTimeout(styleScene, 1200);

      // 1) Show FASTA-based clickable strip right away
      if (fastaText) {
        seqBody.innerHTML = '';
        seqBody.appendChild(buildStripFromFasta(fastaText, pdbe));
      } else {
        // If no FASTA, at least show a minimal placeholder
        const p = document.createElement('div');
        p.className = 'muted';
        p.textContent = 'Waiting for structure…';
        seqBody.innerHTML = ''; seqBody.appendChild(p);
      }

      // 2) Upgrade to structure-derived strip once model is ready
      const model = await waitForModel(pdbe, 12000);
      if (model) {
        const strip = buildStripFromModel(model, pdbe);
        if (strip) {
          seqBody.innerHTML = '';
          seqBody.appendChild(strip);
        }
      }
    }

    load();
  </script>
</body>
</html>
