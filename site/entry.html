<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- PDBe Mol* (3D viewer) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pdbe-molstar@latest/build/pdbe-molstar-light.css">
  <script src="https://cdn.jsdelivr.net/npm/pdbe-molstar@latest/build/pdbe-molstar-plugin.js"></script>

  <!-- ProtVista (interactive sequence) -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/protvista-pdb-3.3.0.js"></script>

  <style>
    :root { --gap:16px }
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header{
      display:flex; gap:10px; align-items:center;
      padding:12px 16px; border-bottom:1px solid #eee; background:#fafafa;
    }
    header a{ text-decoration:none }
    h1{ margin:0; font-size:18px }
    .muted{ color:#666; font-size:13px }

    .page{ display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); padding:16px; }
    @media (max-width: 900px){ .page{ grid-template-columns: 1fr; } }

    .panel{ border:1px solid #e5e5e5; border-radius:8px; overflow:hidden; background:#fff; }
    .viewer-wrap{ height:640px }
    #molstar{ width:100%; height:100% }

    .seq-wrap{ height:640px; display:flex; flex-direction:column }
    .seq-inner{ height:100%; padding:8px; }
    protvista-pdb{ display:block; height:100% }

    .meta{ display:flex; gap:12px; align-items:center; padding:12px 16px; border-top:1px solid #eee }
    .btn{ padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer }
    .error{ color:#b00020; padding:8px 16px }
    .note{ color:#8a6b00; background:#fff8e1; border-top:1px solid #ffe9a8; padding:8px 16px; display:none }
  </style>
</head>
<body>
  <header>
    <a href="index.html">← Back</a>
    <h1 id="title"></h1>
    <span id="uidNote" class="muted"></span>
  </header>

  <div class="page">
    <!-- LEFT: PDBe Mol* -->
    <div class="panel">
      <div class="viewer-wrap">
        <div id="molstar" aria-label="3D structure viewer"></div>
      </div>
      <div class="meta">
        <strong>Files:</strong>
        <a id="cifLink"   target="_blank" rel="noopener">CIF</a>
        <a id="fastaLink" target="_blank" rel="noopener">FASTA</a>
        <button id="copyBtn" class="btn" type="button">Copy FASTA</button>
      </div>
      <div id="viewerErr" class="error" role="alert" aria-live="assertive"></div>
    </div>

    <!-- RIGHT: ProtVista sequence -->
    <div class="panel seq-wrap">
      <div class="seq-inner">
        <protvista-pdb id="pv" custom-data="true" subscribe-events="true"></protvista-pdb>
      </div>
      <div id="pvNote" class="note"></div>
    </div>
  </div>

  <script>
    // ---- tweak here if your chain is not 'A' ----
    const CHAIN_ID_DEFAULT = 'A';

    function getParam(name){ return new URL(location.href).searchParams.get(name); }

    function fastaToSeq(fastaText){
      if (!fastaText) return '';
      return fastaText
        .split(/\r?\n/)
        .filter((ln, i) => !(i === 0 && ln.startsWith('>')))
        .join('')
        .replace(/\s+/g, '')
        .toUpperCase();
    }

    async function load(){
      const uid       = getParam('uid');
      const titleEl   = document.getElementById('title');
      const uidNoteEl = document.getElementById('uidNote');
      const viewerErr = document.getElementById('viewerErr');
      const pvNote    = document.getElementById('pvNote');
      const cifLink   = document.getElementById('cifLink');
      const fastaLink = document.getElementById('fastaLink');
      const copyBtn   = document.getElementById('copyBtn');
      const molDiv    = document.getElementById('molstar');
      const pvEl      = document.getElementById('pv');

      titleEl.textContent = uid || '(missing uid)';
      uidNoteEl.textContent = uid ? `· UniProt ID ${uid}` : '';

      // Load entries.json
      let entry;
      try {
        const catalog = await fetch('../data/entries.json?v=' + Date.now()).then(r=>r.json());
        entry = (catalog.entries || []).find(e => e.uniprot_id === uid);
        if (!entry) throw new Error('NotInCatalog');
      } catch (err) {
        viewerErr.textContent = 'Could not find this entry in entries.json.';
        console.error(err);
        return;
      }

      const cifUrl   = entry.files.structure_cif;
      const fastaUrl = entry.files.sequence_fasta;
      cifLink.href   = cifUrl;
      fastaLink.href = fastaUrl;

      // Fetch FASTA
      let fastaText = '';
      try { fastaText = await fetch(fastaUrl).then(r => r.text()); } catch {}
      if (fastaText) {
        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(fastaText);
            copyBtn.textContent = 'Copied!';
            setTimeout(()=> (copyBtn.textContent = 'Copy FASTA'), 1200);
          } catch {}
        };
      } else {
        copyBtn.disabled = true;
      }

      // ---- PDBe Mol* (left) ----
      let viewer;
      try {
        viewer = new PDBeMolstarPlugin();
        viewer.render(molDiv, {
          customData: { url: cifUrl, format: 'cif' }, // use 'mmcif' if needed
          hideControls: true,
          leftPanel: false,
          rightPanel: false,
          sequencePanel: false,
          bgColor: 'white',
          lighting: 'matte',
          visualStyle: 'cartoon',
          subscribeEvents: true
        });
      } catch (err) {
        viewerErr.textContent = '3D viewer failed to initialize.';
        console.error(err);
        return;
      }

      // ---- ProtVista (right) ----
      const seq = fastaToSeq(fastaText);
      if (!seq) {
        pvNote.style.display = 'block';
        pvNote.textContent = 'No sequence found in FASTA.';
        pvEl.viewerdata = { displayNavigation: true, displaySequence: false, sequence:'', length:0, tracks:[] };
        return;
      }

      pvEl.viewerdata = {
        displayNavigation: true,
        displaySequence:   true,
        sequence:          seq,
        length:            seq.length,
        offset:            1,
        tracks: []
      };

      // ---- sequence → 3D selection ----
      // We need a chainId to map 1D positions to residues; try to infer from Mol* model.
      let chainId = CHAIN_ID_DEFAULT;
      try {
        const plugin = viewer?.viewerInstance?.plugin;
        const structures = plugin?.managers?.structure?.hierarchy?.current?.structures || [];
        const first = structures[0];
        const ah = first?.cell?.obj?.data?.model?.atomicHierarchy;
        const ids = ah?.chains?.label_asym_id?.toArray?.();
        if (ids && ids.length) chainId = ids[0]; // pick the first chain; customize if needed
      } catch (e) {
        console.warn('Could not infer chainId; using default:', CHAIN_ID_DEFAULT);
      }

      function highlightRange(start, end){
        start = Math.max(1, Math.min(seq.length, start|0));
        end   = Math.max(1, Math.min(seq.length, end|0));
        if (end < start) [start, end] = [end, start];
        const data = [];
        for (let r = start; r <= end; r++) data.push({ chainId, residueNumber: r });
        try {
          if (data.length) viewer.visual?.select?.({ data, nonSelectedOpacity: 0.25, focus: false });
          else viewer.visual?.clearSelection?.();
        } catch (e) {
          console.warn('Mol* selection failed:', e);
        }
      }

      // Listen to ProtVista events (name differs slightly across builds; cover common ones)
      document.addEventListener('protvista-selection', e => {
        const { start, end } = e.detail || {};
        if (start && end) highlightRange(start, end);
      });
      document.addEventListener('protvista-click', e => {
        const { start, end } = e.detail || {};
        if (start && end) highlightRange(start, end);
      });
    }

    load();
  </script>
</body>
</html>
