<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- ProtVista (PDBe PDB Component Library) -->
  <link rel="preconnect" href="https://www.ebi.ac.uk">
  <script src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/protvista-pdb-3.3.0.js" defer></script>

  <style>
    :root { --gap: 16px; }
    body { margin: 0; }
    .page {
      padding: 16px;
    }
    .topbar a { text-decoration: none; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-items: start;
    }
    @media (max-width: 1000px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      overflow: hidden;
    }
    .card-body { padding: 12px; }

    /* Viewer card */
    .viewer {
      display: flex;
      flex-direction: column;
    }
    #viewer-frame {
      width: 100%;
      height: 640px;
      border: 0;
      display: block;
    }

    /* Sequence side */
    .meta {
      display: flex; gap: 12px; align-items: center;
      margin: 8px 0 16px;
    }
    .meta a { text-decoration: none; }
    .btn { padding: 6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; background:#fafafa; }
    .btn:disabled { opacity: 0.6; cursor: default; }
    .error { color:#b00020; margin-top:8px; }
    pre { white-space: pre-wrap; }

    /* Give ProtVista some vertical room */
    protvista-pdb {
      display: block;
      min-height: 360px; /* increase if you want more tracks visible */
      border: 1px solid #eee;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <a href="index.html">← Back</a>
      <h1 id="title" style="margin: 12px 0 16px;"></h1>
    </div>

    <div class="grid">
      <!-- LEFT: Mol* minimal (your existing, stable approach) -->
      <div class="card viewer">
        <iframe id="viewer-frame" src="about:blank" title="Mol* Viewer (minimal)"></iframe>
      </div>

      <!-- RIGHT: Interactive sequence (ProtVista) + FASTA & actions -->
      <div class="card">
        <div class="card-body">
          <div class="meta">
            <strong>Files:</strong>
            <a id="cifLink"   target="_blank" rel="noopener">CIF</a>
            <a id="fastaLink" target="_blank" rel="noopener">FASTA</a>
            <button id="copyBtn" class="btn" type="button">Copy FASTA</button>
          </div>

          <div id="err" class="error"></div>

          <!-- ProtVista: interactive sequence/feature viewer like AlphaFold -->
          <!-- We set the 'accession' attribute from JS after we know the UID -->
          <protvista-pdb id="pv"></protvista-pdb>

          <h2 style="margin-top:16px;">Sequence (FASTA)</h2>
          <pre id="fasta">Loading...</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    function getParam(name){ return new URL(location.href).searchParams.get(name); }

    async function load(){
      const uid      = getParam('uid');
      const titleEl  = document.getElementById('title');
      const fastaEl  = document.getElementById('fasta');
      const cifLink  = document.getElementById('cifLink');
      const fastaLink= document.getElementById('fastaLink');
      const frame    = document.getElementById('viewer-frame');
      const copyBtn  = document.getElementById('copyBtn');
      const errEl    = document.getElementById('err');
      const pv       = document.getElementById('pv');

      titleEl.textContent = uid || '(missing uid)';

      // Load catalog (with cache-buster)
      let catalog;
      try {
        catalog = await fetch('../data/entries.json?v=' + Date.now()).then(r=>r.json());
      } catch {
        errEl.textContent = 'Could not load entries.json.';
        return;
      }

      const entry = (catalog.entries || []).find(e => e.uniprot_id === uid);
      if(!entry){ errEl.textContent = 'Entry not found in catalog.'; return; }

      // Wire file links
      const cifUrl   = entry.files.structure_cif;
      const fastaUrl = entry.files.sequence_fasta;
      cifLink.href   = cifUrl;
      fastaLink.href = fastaUrl;

      // FASTA text + copy button
      try {
        const t = await fetch(fastaUrl).then(r=>r.text());
        fastaEl.textContent = t;
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(t);
          const prev = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          setTimeout(()=> (copyBtn.textContent = prev), 1200);
        };
      } catch {
        fastaEl.textContent = 'FASTA not available.';
        copyBtn.disabled = true;
      }

      // --- Mol* minimal viewer in iframe (your current, working approach) ---
      const encodedCif = encodeURIComponent(cifUrl);
      const viewerUrl =
        `https://molstar.org/viewer/?structure-url=${encodedCif}` +
        `&structure-url-format=mmcif` +
        `&hide-controls=1` +
        `&representation=cartoon&color-theme=uniform&color-value=0x4682B4&bgcolor=white&outline=1&lighting=soft`;
      frame.src = viewerUrl;

      // --- ProtVista interactive sequence like AlphaFold ---
      // ProtVista uses UniProt accessions (without isoform suffix).
      // If your uid is "P05067-4", ProtVista annotations usually live under "P05067".
      const uniprotForPv = (uid || '').split('-')[0];
      pv.setAttribute('accession', uniprotForPv);

      // Optional: wait a moment and warn if ProtVista didn’t render anything
      setTimeout(() => {
        // If the element size is tiny or there's no shadow DOM yet, give a gentle nudge to the user.
        if (pv.clientHeight < 120) {
          // Don’t overwrite real errors if any
          if (!errEl.textContent) {
            errEl.textContent =
              'Note: ProtVista may not show features for some isoforms. ' +
              'If this panel is empty for e.g. "P05067-4", try the base accession "P05067".';
          }
        }
      }, 1500);
    }

    load();
  </script>
</body>
</html>
