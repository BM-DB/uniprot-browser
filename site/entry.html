<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- ProtVista dependencies (needed for the right-hand interactive sequence) -->
  <link rel="stylesheet" href="https://ebi.emblstatic.net/web_guidelines/EBI-Icon-fonts/v1.2/fonts.css" type="text/css" media="all"/>
  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
  <script src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/protvista-pdb-3.3.0.js"></script>

  <style>
    /* page layout: viewer left, sequence right */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    .viewer-card, .seq-card {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }
    #viewer-frame {
      width: 100%;
      height: 640px;
      border: 0;
      display: block;
      background: #fff;
    }
    /* Make the ProtVista panel fill its card nicely */
    .seq-card protvista-pdb {
      display: block;
      height: 640px;
      /* ProtVista handles its own internal scrolling/zooming */
    }

    .meta {
      display: flex; gap: 12px; align-items: center;
      margin: 8px 0 16px;
    }
    .meta a { text-decoration: none; }
    .error { color:#b00020; margin-top:8px; }
    .btn { padding: 6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <a href="index.html">‚Üê Back</a>
  <h1 id="title"></h1>

  <div class="two-col">
    <!-- LEFT: Mol* viewer (unchanged minimal iframe) -->
    <div class="viewer-card">
      <iframe id="viewer-frame" src="about:blank" title="Mol* Viewer (minimal)"></iframe>
    </div>

    <!-- RIGHT: Interactive sequence (ProtVista) -->
    <div class="seq-card">
      <!-- custom-data mode lets us supply our own sequence/features -->
      <protvista-pdb id="seqView" custom-data="true"></protvista-pdb>
    </div>
  </div>

  <div class="meta">
    <strong>Files:</strong>
    <a id="cifLink"   target="_blank" rel="noopener">CIF</a>
    <a id="fastaLink" target="_blank" rel="noopener">FASTA</a>
    <button id="copyBtn" class="btn" type="button">Copy FASTA</button>
  </div>

  <div id="err" class="error"></div>

  <script>
    function getParam(name){ return new URL(location.href).searchParams.get(name); }

    // tiny helper: turn FASTA text into a single sequence string
    function fastaToSequence(fastaText) {
      return fastaText
        .split(/\r?\n/)
        .filter(line => !line.startsWith('>'))
        .join('')
        .replace(/\s+/g, '')
        .trim();
    }

    async function load(){
      const uid      = getParam('uid');
      const errEl    = document.getElementById('err');
      const titleEl  = document.getElementById('title');
      const cifLink  = document.getElementById('cifLink');
      const fastaLink= document.getElementById('fastaLink');
      const copyBtn  = document.getElementById('copyBtn');
      const frame    = document.getElementById('viewer-frame');
      const seqView  = document.getElementById('seqView');

      titleEl.textContent = uid || '(missing uid)';

      // Load catalog with a cache-buster
      let catalog;
      try {
        catalog = await fetch('../data/entries.json?v=' + Date.now()).then(r=>r.json());
      } catch {
        errEl.textContent = 'Could not load entries.json.'; return;
      }

      const entry = (catalog.entries || []).find(e => e.uniprot_id === uid);
      if(!entry){ errEl.textContent = 'Entry not found in catalog.'; return; }

      // Wire file links
      const cifUrl   = entry.files.structure_cif;
      const fastaUrl = entry.files.sequence_fasta;
      cifLink.href   = cifUrl;
      fastaLink.href = fastaUrl;

      // Load FASTA and wire copy button
      let fastaText = '';
      try {
        fastaText = await fetch(fastaUrl).then(r=>r.text());
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(fastaText);
          copyBtn.textContent = 'Copied!';
          setTimeout(()=> (copyBtn.textContent = 'Copy FASTA'), 1200);
        };
      } catch {
        errEl.textContent = 'FASTA not available.';
        copyBtn.disabled = true;
      }

      // LEFT: Mol* minimal viewer (unchanged)
      const encodedCif = encodeURIComponent(cifUrl);
      const viewerUrl =
        `https://molstar.org/viewer/?structure-url=${encodedCif}` +
        `&structure-url-format=mmcif&hide-controls=1`;
      frame.src = viewerUrl;

      // RIGHT: Build ProtVista custom data from the FASTA sequence
      const seq = fastaToSequence(fastaText);
      if (!seq) {
        // No sequence -> show nothing but avoid errors
        seqView.viewerdata = {
          displayNavigation: true,
          displaySequence: false,
          sequence: '',
          length: 0,
          tracks: []
        };
        return;
      }

      const customData = {
        displayNavigation: true,   // top ruler with zoom/pan
        displaySequence: true,     // actual sequence letters track
        sequence: seq,             // protein sequence (no spaces/newlines)
        length: seq.length,
        offset: 1,                 // residues start at 1
        // You can add your own feature tracks here later (domains, motifs, etc.)
        tracks: []
      };

      // Assign the data to the web component (per PDBe example)
      // ref: PDBe custom-data demo: viewerdata property
      seqView.viewerdata = customData;

      // Optional: wire basic hover/click events from ProtVista (for future use)
      // document.addEventListener('protvista-click', e => console.log('pv-click', e.detail));
      // document.addEventListener('protvista-mouseover', e => console.log('pv-over', e.detail));
    }

    load();
  </script>
</body>
</html>
