<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .viewer-card {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
      background: #fff;
    }
    #viewer-frame {
      width: 100%;
      height: 640px;  /* adjust height if you want */
      border: 0;
      display: block;
    }
    .meta {
      display: flex; gap: 12px; align-items: center;
      margin: 8px 0 16px;
    }
    .meta a { text-decoration: none; }
    .error { color:#b00020; margin-top:8px; }
    .btn { padding: 6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <a href="index.html">‚Üê Back</a>
  <h1 id="title"></h1>

  <div class="viewer-card">
    <iframe id="viewer-frame" src="about:blank" title="Mol* Viewer (minimal)"></iframe>
  </div>

  <div class="meta">
    <strong>Files:</strong>
    <a id="cifLink"   target="_blank" rel="noopener">CIF</a>
    <a id="fastaLink" target="_blank" rel="noopener">FASTA</a>
    <button id="copyBtn" class="btn" type="button">Copy FASTA</button>
  </div>

  <div id="err" class="error"></div>

  <h2>Sequence (FASTA)</h2>
  <pre id="fasta">Loading...</pre>

  <script>
    function getParam(name){ return new URL(location.href).searchParams.get(name); }

    async function load(){
      const uid      = getParam('uid');
      const errEl    = document.getElementById('err');
      const titleEl  = document.getElementById('title');
      const fastaEl  = document.getElementById('fasta');
      const cifLink  = document.getElementById('cifLink');
      const fastaLink= document.getElementById('fastaLink');
      const frame    = document.getElementById('viewer-frame');
      const copyBtn  = document.getElementById('copyBtn');

      titleEl.textContent = uid || '(missing uid)';

      // Load catalog with a cache-buster
      let catalog;
      try {
        catalog = await fetch('../data/entries.json?v=' + Date.now()).then(r=>r.json());
      } catch {
        errEl.textContent = 'Could not load entries.json.'; return;
      }

      const entry = (catalog.entries || []).find(e => e.uniprot_id === uid);
      if(!entry){ errEl.textContent = 'Entry not found in catalog.'; return; }

      // Wire file links
      const cifUrl   = entry.files.structure_cif;
      const fastaUrl = entry.files.sequence_fasta;
      cifLink.href   = cifUrl;
      fastaLink.href = fastaUrl;

      // Show FASTA text
      try {
        const t = await fetch(fastaUrl).then(r=>r.text());
        fastaEl.textContent = t;
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(t);
          copyBtn.textContent = 'Copied!';
          setTimeout(()=> (copyBtn.textContent = 'Copy FASTA'), 1200);
        };
      } catch {
        fastaEl.textContent = 'FASTA not available.';
        copyBtn.disabled = true;
      }

      // Build Mol* hosted viewer URL in "minimal" mode
      // Prefer mmCIF; if you KNOW some are legacy PDB/CIF, change 'mmcif' to 'cif' for those.
      const encodedCif = encodeURIComponent(cifUrl);
      const viewerUrl =
        `https://molstar.org/viewer/?url=${encodedCif}` +
        `&format=mmcif` +
        `&hide-ui=1` +                      // removes interface panels
        `&representation=cartoon` +         // cartoon/ribbon representation
        `&color-theme=uniform` +            // one color
        `&color-value=0x4682B4` +           // steel blue (you can change this hex)
        `&bgcolor=white` +                  // white background
        `&lighting=soft` +                  // soft lighting
        `&outline=1`;                       // enable black outline

      // Load into the iframe
      frame.src = viewerUrl;
    }

    load();
  </script>
</body>
</html>
