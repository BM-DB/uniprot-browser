<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="styles.css" />

  <!-- PDBe Mol* CSS + JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pdbe-molstar@latest/build/pdbe-molstar.css" />
  <script src="https://cdn.jsdelivr.net/npm/pdbe-molstar@latest/build/pdbe-molstar-plugin.js"></script>

  <!-- ProtVista PDB local -->
  <script src="./vendor/protvista-pdb/d3.v4.min.js"></script>
  <script src="./vendor/protvista-pdb/protvista-pdb-3.3.0.js"></script>

  <style>
    body { margin:16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#fafafa; }
    h1 { margin-top: 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; min-height:640px; display:flex; flex-direction:column; }
    .card-header { padding:8px 12px; background:#f7f7f7; border-bottom:1px solid #ddd; font-weight:600; }
    .card-body { position:relative; flex:1 1 auto; }
    #molstar { position:absolute; inset:0; }
    #seqPanel { position:absolute; inset:0; }
    protvista-pdb { display:block; width:100%; height:100%; }
    .meta { margin:12px 0; display:flex; gap:12px; align-items:center; }
    .btn { padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; }
    .error { color:#b00020; margin-top:8px; }
    @media(max-width:900px){ .row { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <a href="index.html">← Back</a>
  <h1 id="title"></h1>

  <div class="meta">
    <strong>Files:</strong>
    <a id="cifLink" target="_blank" rel="noopener">CIF</a>
    <a id="fastaLink" target="_blank" rel="noopener">FASTA</a>
    <button id="copyBtn" class="btn" type="button">Copy FASTA</button>
  </div>

  <div id="err" class="error"></div>

  <div class="row">
    <!-- Left: 3D viewer -->
    <section class="card">
      <div class="card-header">Structure</div>
      <div class="card-body"><div id="molstar"></div></div>
    </section>

    <!-- Right: Sequence panel (ProtVista PDB) -->
    <section class="card">
      <div class="card-header">Sequence</div>
      <div class="card-body"><div id="seqPanel"><protvista-pdb id="seq"></protvista-pdb></div></div>
    </section>
  </div>

  <script>
    function getParam(name) { return new URL(location.href).searchParams.get(name); }

    async function load() {
      const uid = getParam('uid');
      const titleEl = document.getElementById('title');
      const errEl = document.getElementById('err');
      const cifLink = document.getElementById('cifLink');
      const fastaLink = document.getElementById('fastaLink');
      const copyBtn = document.getElementById('copyBtn');

      titleEl.textContent = uid || '(missing uid)';

      let catalog;
      try {
        catalog = await fetch('../data/entries.json?v=' + Date.now()).then(r=>r.json());
      } catch(e) {
        errEl.textContent = 'Could not load entries.json.';
        console.error(e);
        return;
      }

      const entry = (catalog.entries || []).find(e => e.uniprot_id === uid);
      if (!entry) {
        errEl.textContent = 'Entry not found in catalog.';
        return;
      }

      const cifUrl   = entry.files.structure_cif;
      const fastaUrl = entry.files.sequence_fasta;
      cifLink.href   = cifUrl;
      fastaLink.href = fastaUrl;

      // Load FASTA text
      let fastaText = '';
      try {
        fastaText = await fetch(fastaUrl).then(r=>r.text());
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(fastaText);
          copyBtn.textContent = 'Copied!';
          setTimeout(()=> (copyBtn.textContent = 'Copy FASTA'), 1200);
        };
      } catch(e) {
        copyBtn.disabled = true;
      }

      // -------------------------------------------------------------------------
      // 1) Initialize Mol* viewer
      const viewer = new PDBeMolstarPlugin();
      await viewer.render('molstar', {
        customData: { url: cifUrl, format: 'cif' },
        hideControls: true,
        bgColor: { r:255, g:255, b:255 }
      });

      // -------------------------------------------------------------------------
      // 2) Initialize ProtVista PDB (sequence panel)
      const pv = document.getElementById('seq');
      // Use the UniProt accession directly (ProtVista knows how to fetch annotations)
      pv.accession = uid;

      // 3) Set up interactive linking: sequence selection → structure highlight
      pv.addEventListener('change', e => {
        const d = e.detail || {};
        const start = d.start|0, end = d.end|0;
        if (!start || !end) return;
        viewer.visual.select({ data: { residues: [{ start, end }] } });
      });
    }

    load();
  </script>
</body>
</html>
