<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entry</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- 3Dmol.js (pinned) -->
  <script src="https://unpkg.com/3dmol@2.4.0/build/3Dmol-min.js"></script>
  <style>
    #viewer { width: 100%; height: 640px; border: 1px solid #ddd; }
    #err { color:#b00020; margin-top:8px; }
  </style>
</head>
<body>
  <a href="index.html">‚Üê Back</a>
  <h1 id="title"></h1>

  <div id="viewer"></div>
  <div id="err"></div>

  <h2>Sequence (FASTA)</h2>
  <pre id="fasta">Loading...</pre>

  <script>
    function getParam(name){ return new URL(location.href).searchParams.get(name); }

    async function load(){
      const uid = getParam('uid');
      document.getElementById('title').textContent = uid || '(missing uid)';
      const errEl = document.getElementById('err');

      // Load catalog (cache-busted)
      let catalog;
      try {
        catalog = await fetch('../data/entries.json?v=dmol').then(r => r.json());
      } catch {
        errEl.textContent = 'Could not load entries.json';
        return;
      }
      const entry = catalog.entries.find(e => e.uniprot_id === uid);
      if(!entry){ errEl.textContent = 'Entry not found in catalog.'; return; }

      // Show FASTA (best-effort)
      fetch(entry.files.sequence_fasta)
        .then(r => r.text())
        .then(t => { document.getElementById('fasta').textContent = t; })
        .catch(() => { document.getElementById('fasta').textContent = 'FASTA not available.'; });

      // ---- 3Dmol: fetch text and addModel explicitly (mmcif -> cif) ----
      const url = entry.files.structure_cif;
      const viewer = $3Dmol.createViewer('viewer', { backgroundAlpha: 1 });

      try {
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();

        let loaded = false;
        try {
          viewer.addModel(text, 'mmcif'); // try as mmCIF
          loaded = true;
        } catch(e1) {
          console.warn('mmcif parse failed, retrying as cif', e1);
          try {
            viewer.addModel(text, 'cif'); // fallback as CIF
            loaded = true;
          } catch(e2) {
            console.error('cif parse failed', e2);
          }
        }

        if(!loaded) {
          errEl.textContent = 'Could not parse structure (tried mmCIF then CIF).';
          return;
        }

        viewer.setStyle({}, { cartoon: {} });
        viewer.zoomTo();
        viewer.render();
      } catch(e) {
        console.error('3D viewer failed', e);
        errEl.textContent = 'Could not load structure from URL. Open the CIF link above to verify.';
      }
    }

    load();
  </script>
</body>
</html>
